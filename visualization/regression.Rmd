---
title: "회귀분석"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 다중회귀분석

```{r cars, message=FALSE, warning=FALSE}
library(MVN)
library(car)
library(forecast)
library(lsr)
library(MASS)

#원본데이터
real<-read.csv('/Users/SELEN/Downloads/WorldHappiness_Corruption_2015_2020.csv') 

#파이썬에서 결측값 전처리한 데이터
df=read.csv('/Users/SELEN/Downloads/happiness.csv')
head(df)
```

```{r message=TRUE}
summary(df)
```

# 회귀분석
```{r  message=TRUE}
lm_df_f<-lm(data=df, happiness_score~gdp_per_capita+family+health+freedom+generosity+government_trust+dystopia_residual+Year+social_support+cpi_score)
summary(lm_df_f)
```
social_support 변수의 p값이 0.35967>0.05 이므로 유의하지 않은 변수이다.

### 단계적 선택법
```{r}
null_reg<-lm(happiness_score~1, data=df) #영모형
reg<-step(null_reg, direction = "both", scope = list(lower=null_reg,upper=lm_df_f))
```
AIC를 평가 기준으로 하여 단계적 선택법을 적용한 결과 social support를 제외했을 때가 AIC가 제일 낮으므로 최적의 모델이다.

* AIC = -2*loglikelihood+2*q 로 모형의 적합도와 복잡도를 반영한 값이다.

```{r }
summary(reg)
```
social support 제거된 모델인 reg의 정보를 확인해 보면 모든 변수가 유의하다. Adjusted R-squared은 0.9785로 높은 설명력을 가진다.

```{r }
anova(reg)
```
회귀모형의 순차분산분석을 실시하여 추가적으로 설명하는 SSR을 알 수 있다.


# 모형진단
```{r }
par(mfrow = c(2, 2))
plot(reg)
```

회귀 모형은 오차의 등분산성, 정규성, 독립성을, 회귀모형의 선형성을 만족해야한다.

```{r }
#잔차 plot
residualPlots(reg)
```
각 변수에 대해 잔차 설명변수 산점도를 그려 등분산성과 선형성을 알 수 있다.

### 1. 정규성
```{r}
qqPlot(residuals(reg))
```
qqplot을 그려보면 정규성에서 벗어나는 것을 볼 수 있다.
*파란 선에 가까울 수록 정규성을 만족한다.

```{r}
shapiro.test(residuals(reg))
```
shapiro-wilk 검정을 이용하면 p 값이 <.001이므로 오차가 정규분포를 따른다는 귀무가설을 기각한다. 즉, 오차의 정규성을 가정할 수 없다. 

### 선형성
```{r }
residualPlots(reg)
```
잔차 설명변수 산점도를 그리면 dystopia residual을 제외하고는 대체로 선형인 것으로 보인다.

### 등분산성
```{r }
ncvTest(reg)
```
p<0.05이므로 등분산성을 띈다는 귀무가설을 기각한다. 즉, 오차는 이분산성을 띈다.

### 독립성
```{r}
durbinWatsonTest(reg)
```
D-W Statistic이 2에 가까우므로 독립성 만족한다.


모형은 오차의 정규성과 등분산성을 만족시키지 못한다.


## 다중공선성
변수간에 선형관계가 존재할 경우 변수를 제거할 수 있다.
```{r}
vif(reg)
```
모두 5보다 작으므로 다중공선성은 없다고 볼 수 있다.

## 이상점
```{r }
outlierTest(reg)
```
Bonferroni검정을 통해 모형을 제대로 따르지 않는 관측값을 찾을 수 있으며, 이상치는 360 356 407 487 392 428 415 번째 관측값이다. 

```{r }
real[c(360,356,407,487,392,415,428),]
```
이상점은 자료입력의 오류 등의 경우일 경우 다시 실험하거나 제거해야 하지만, 잘못 기입된 것은 아닌 것 같다. 이상점을 임의로 제거하는 것은 바람직하지 않으므로 이상점을 제거한 데이터를 dff로 새로 저장하여 비교하고자 한다.
```{r }
dff=df[-c(360,356,407,487,392,415,428),]
```

## 영향력 관측값
```{r }
influencePlot(reg)
```
스튜던트화 잔차와 hat, cook의 D통계량을 확인해볼 수 있다.영향력있는 값은 100,261,356,360 이다.
```{r }
plot(reg, which=4)
```

#### 변수변환
등분산성과 정규성을 만족시키기 위해 box-cox변환을 통해 종속변수, box-tidwell을 통해 설명변수의 변환을 진행해 보았다
```{r }
yy=df$happiness_score**1.2

a2=df$family**1.6
a3=df$health**1.7
a4=df$freedom**1.8
a0=df$cpi_score**1.6

reg1<-lm(data=df, yy~gdp_per_capita+a2+a3+a4+generosity+government_trust+dystopia_residual+Year+dystopia_residual+a0)
summary(reg1)
```

```{r}
shapiro.test(residuals(reg1)) #정규성
ncvTest(reg1) #등분산
```
이분산성이 소폭 해결 된 모습이 있지만, box-cox와 box-tidwell의 변환으로도 해결되지 않는다.

```{r }
reg2<-lm(data=dff, happiness_score~gdp_per_capita+family+health+freedom+generosity+government_trust+dystopia_residual+Year+cpi_score)
summary(reg2)
```
이상점을 제거한 회귀 모델이다.
```{r}
shapiro.test(residuals(reg2)) #정규성
ncvTest(reg2) #등분산
```
정규성과 이분산성이 해결되진 않았지만, Adjusted R이 상승한 것을 볼 수 있다.

<최종 회귀모델>
-49.2+0.946*gdp_per_capita+1.03*family+1.07*health+1.09*freedom+0.869*generosity+0.872*government_trust+0.979*dystopia_residual+0.02*Year+0.0006*cpi_score